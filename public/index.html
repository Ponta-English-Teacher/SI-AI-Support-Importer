<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SI AI Support Importer</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .task { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
    .chat { white-space: pre-wrap; margin-bottom: 8px; }
    .controls { margin-top: 8px; }
    button { margin-right: 6px; }
  </style>
</head>
<body>
  <h1>SI AI Support (Importer)</h1>

  <p>
    <strong>üìÇ Load Saved Work:</strong>
    <input type="file" id="importFile" />
  </p>

  <div id="tasks"></div>

  <script>
    // ========= CONFIG =========
    const API_CHAT = "https://si-ai-support-importer.vercel.app/api/chat";
    let chatHistories = {};

    // ========= TASK PROMPTS =========
    const taskPrompts = {
      1: "You are a friendly assistant helping a student build a self-introduction presentation. Ask one question at a time...",
      2: "You are helping the student reflect on their personality. Ask one question at a time...",
      3: "You are helping the student discover their personal theme. Ask one question at a time...",
      4: "You are helping the student plan slides. Ask one question at a time...",
      5: "You are helping the student practice narration. Ask one question at a time..."
    };

    // ========= UI BUILD =========
    function createTask(taskNum, title, desc) {
      const container = document.createElement("div");
      container.className = "task";
      container.innerHTML = `
        <h2>Task ${taskNum}: ${title}</h2>
        <p>${desc}</p>
        <div class="chat" id="chat${taskNum}"></div>
        <input id="input${taskNum}" placeholder="Type here..." style="display:none;"/>
        <button id="send${taskNum}" style="display:none;">Send</button>
        <button onclick="startTask(${taskNum})">Start Task ${taskNum}</button>
      `;
      document.getElementById("tasks").appendChild(container);
    }

    createTask(1, "Basic Profile", "Start the conversation to collect your personal profile.");
    createTask(2, "Personality Reflection", "Reflect on your personality traits through questions.");
    createTask(3, "Discover Your Theme", "Explore what shaped you and your message.");
    createTask(4, "Slide Planning", "Organize your content into presentation slides.");
    createTask(5, "Narration Practice", "Finalize your speech and improve it together.");

    // ========= CHAT LOGIC =========
    async function startTask(taskNum) {
      const chatBox = document.getElementById(`chat${taskNum}`);
      const inputBox = document.getElementById(`input${taskNum}`);
      const sendBtn = document.getElementById(`send${taskNum}`);

      chatBox.style.display = inputBox.style.display = sendBtn.style.display = "block";

      // Initialize history
      chatHistories[taskNum] = chatHistories[taskNum] || [];

      // Send initial system prompt
      chatHistories[taskNum].push({ role: "system", content: taskPrompts[taskNum] });
      chatHistories[taskNum].push({ role: "user", content: "Let's begin Task " + taskNum + "." });

      const reply = await callAPI(chatHistories[taskNum]);
      chatHistories[taskNum].push({ role: "assistant", content: reply });
      renderChat(taskNum);

      sendBtn.onclick = () => sendToGPT(taskNum);
    }

    async function sendToGPT(taskNum) {
      const inputBox = document.getElementById(`input${taskNum}`);
      const msg = inputBox.value.trim();
      if (!msg) return;
      inputBox.value = "";

      chatHistories[taskNum].push({ role: "user", content: msg });
      renderChat(taskNum);

      const reply = await callAPI(chatHistories[taskNum]);
      chatHistories[taskNum].push({ role: "assistant", content: reply });
      renderChat(taskNum);
    }

    async function callAPI(history) {
      const res = await fetch(API_CHAT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages: history })
      });
      const data = await res.json();
      return data.reply || "[No response]";
    }

    function renderChat(taskNum) {
      const chatBox = document.getElementById(`chat${taskNum}`);
      chatBox.innerText = chatHistories[taskNum]
        .filter(m => m.role === "user" || m.role === "assistant")
        .map(m => (m.role === "user" ? "You: " : "ChatGPT: ") + m.content)
        .join("\n\n");
    }

    // ========= IMPORT LOGIC =========
    document.getElementById("importFile").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const text = await file.text();

      const match = text.match(/window\.SAVED_STATE\s*=\s*(\{.*\});/s);
      if (match) {
        try {
          window.SAVED_STATE = JSON.parse(match[1]);
          chatHistories = window.SAVED_STATE.chatHistories || {};
          Object.keys(chatHistories).forEach(taskNum => renderChat(taskNum));
          alert("‚úÖ Saved work loaded! You can continue typing.");
        } catch (err) {
          alert("‚ùå Could not parse saved state: " + err.message);
        }
      } else {
        alert("‚ùå No saved state found in this file.");
      }
    });
  </script>
</body>
</html>

